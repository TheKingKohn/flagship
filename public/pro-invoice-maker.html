<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pro Invoice & Estimate Maker â€” Single File</title>
<style>
  :root{
    --accent:#3b82f6; /* changeable */
    --ink:#0b0f19;
    --bg:#f7f7fb;
    --card:#ffffff;
    --muted:#64748b;
    --line:#e5e7eb;
  }
  :root.dark{
    --bg:#0b0f19;
    --card:#111827;
    --ink:#e5e7eb;
    --muted:#9ca3af;
    --line:#1f2937;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink); background:var(--bg);
  }
  .wrap{max-width:1200px; margin:24px auto; padding:0 16px}
  .toolbar{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; margin-bottom:12px;
  }
  .toolbar .left,.toolbar .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .btn{
    border:1px solid var(--line); background:var(--card); color:var(--ink); padding:10px 14px; border-radius:10px; cursor:pointer;
  }
  .btn.primary{ background:var(--accent); border-color:var(--accent); color:#fff; }
  .btn.danger{ background:#ef4444; border-color:#ef4444; color:#fff; }
  .btn:disabled{opacity:.6; cursor:not-allowed}
  input, select, textarea{
    width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:var(--card); color:var(--ink);
  }
  label{font-weight:600; font-size:12px; color:var(--muted)}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:repeat(2,1fr)}
  .g3{grid-template-columns:repeat(3,1fr)}
  .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px}
  .section-title{font-weight:700; margin:2px 0 12px 0; font-size:16px}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .grow{flex:1}
  .accent{color:var(--accent)}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:var(--card)}
  .muted{color:var(--muted)}
  .logo-box{width:160px; height:160px; border:2px dashed var(--line); border-radius:16px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:var(--bg)}
  .logo-box img{max-width:100%; max-height:100%}
  .items table{width:100%; border-collapse:collapse; background:var(--card); border-radius:12px; overflow:hidden}
  .items th, .items td{border-bottom:1px solid var(--line); padding:10px; vertical-align:top}
  .items th{font-size:12px; color:var(--muted); text-align:left}
  .items td:last-child,.items th:last-child{text-align:right}
  .items input, .items textarea{border:1px solid var(--line); background:var(--card)}
  .items textarea{min-height:44px; resize:vertical}
  .items .row-actions{display:flex; justify-content:flex-end; gap:8px}
  .summary{
    display:grid; gap:10px; grid-template-columns:1fr minmax(300px, 380px);
  }
  .totals{
    background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px;
  }
  .totals .line{display:flex; justify-content:space-between; padding:6px 0}
  .totals .line.total{font-weight:800; font-size:18px; border-top:1px dashed var(--line); margin-top:6px; padding-top:12px}
  .sig{
    background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px;
  }
  .sig canvas{width:100%; height:180px; border:1px dashed var(--line); border-radius:12px; background:#fff}
  .brand-controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .hint{font-size:12px; color:var(--muted)}
  .notice{background:rgba(59,130,246,.12); border:1px solid rgba(59,130,246,.35); color:var(--ink); padding:10px 12px; border-radius:12px}
  .badge{background:var(--accent); color:#fff; font-weight:700; padding:4px 8px; border-radius:999px}
  .type-toggle{display:flex; gap:8px; align-items:center}
  .hidden{display:none !important}
  /* Additional utility styles */
  .w-60{width:60px}
  .w-140{width:140px; text-align:right}
  .mt-8{margin-top:8px}
  .mt-10{margin-top:10px}
  .mt-12{margin-top:12px}
  .m-0{margin:0}
  .fw-800{font-weight:800}
  .ta-right{text-align:right}
  .td-actions{text-align:right; padding:10px}
  .items-center{align-items:center}
  .justify-between{justify-content:space-between}
  .th-item{width:40%}
  .th-qty{width:10%}
  .th-price{width:15%}
  .th-tax{width:10%}
  .th-total{width:15%}
  .th-actions{width:10%}
  /* Print styles */
  @media print{
    body{background:#fff}
    .toolbar, .brand-controls, .controls-only, #importJsonInput{display:none !important}
    .wrap{max-width:none; margin:0; padding:0}
    .card{border:none}
    .items td input, .items td textarea, input, select, textarea{border:none; padding:0}
    .logo-box{border:none}
    a{color:inherit; text-decoration:none}
    .page{break-inside:avoid-page}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="left">
      <span class="badge" id="docTypeBadge">INVOICE</span>
      <div class="type-toggle">
        <label class="muted">Type</label>
        <select id="docType" class="pill" title="Document Type">
          <option value="Invoice">Invoice</option>
          <option value="Estimate">Estimate</option>
        </select>
      </div>
      <div class="brand-controls">
        <label class="muted">Currency</label>
        <input id="currencySymbol" class="pill w-60" value="$" title="Currency Symbol" />
        <label class="muted">Accent</label>
        <input id="accentPicker" class="pill" type="color" value="#3b82f6" title="Accent Color" />
        <button id="darkModeBtn" class="pill">ðŸŒ™ Dark</button>
      </div>
    </div>
    <div class="right">
      <button class="btn" id="newBtn">New</button>
      <button class="btn" id="saveBtn">Save Template</button>
      <select id="loadSelect" class="pill" title="Load Template">
        <option value="">Load Templateâ€¦</option>
      </select>
      <button class="btn" id="exportBtn">Export JSON</button>
      <input id="importJsonInput" type="file" accept=".json" class="hidden" title="Import JSON File" />
      <button class="btn" id="importBtn">Import JSON</button>
      <button class="btn primary" id="printBtn">Print / Save PDF</button>
    </div>
  </div>

  <div class="grid g3">
    <div class="card page">
      <div class="section-title">Your Business</div>
      <div class="row">
        <div class="logo-box" id="logoBox"><span class="muted">Logo</span></div>
        <div class="grow grid">
          <div>
            <label>Business / Name</label>
            <input id="bizName" placeholder="Acme LLC" />
          </div>
          <div>
            <label>Email</label>
            <input id="bizEmail" placeholder="hello@acme.com" />
          </div>
          <div class="grid g2">
            <div>
              <label>Phone</label>
              <input id="bizPhone" placeholder="(555) 123-4567" />
            </div>
            <div>
              <label>Website</label>
              <input id="bizWebsite" placeholder="acme.com" />
            </div>
          </div>
        </div>
      </div>
      <div class="mt-10">
        <label>Address</label>
        <textarea id="bizAddress" placeholder="123 Main St&#10;Springfield, USA"></textarea>
      </div>
      <div class="controls-only row mt-8">
        <input type="file" id="logoInput" accept="image/*" title="Upload Logo" />
        <button class="btn danger" id="clearLogoBtn">Clear Logo</button>
      </div>
    </div>

    <div class="card page">
      <div class="section-title">Bill To</div>
      <div class="grid">
        <div>
          <label>Client / Company</label>
          <input id="clientName" placeholder="Client Co." />
        </div>
        <div class="grid g2">
          <div>
            <label>Client Email</label>
            <input id="clientEmail" placeholder="ap@client.com" />
          </div>
          <div>
            <label>Client Phone</label>
            <input id="clientPhone" placeholder="(555) 222-3333" />
          </div>
        </div>
        <div>
          <label>Client Address</label>
          <textarea id="clientAddress" placeholder="555 Market St&#10;Metropolis, USA"></textarea>
        </div>
      </div>
    </div>

    <div class="card page">
      <div class="section-title">Details</div>
      <div class="grid g2">
        <div>
          <label>Number</label>
          <input id="invNumber" title="Invoice Number" />
        </div>
        <div>
          <label>Date</label>
          <input id="invDate" type="date" title="Invoice Date" />
        </div>
        <div>
          <label>Due Date</label>
          <input id="dueDate" type="date" title="Due Date" />
        </div>
        <div>
          <label>P.O. / Ref.</label>
          <input id="poNumber" placeholder="Optional" />
        </div>
      </div>
      <div class="notice mt-10">
        Tip: Use <b>Print / Save PDF</b> to generate a polished PDF. All controls are hidden automatically.
      </div>
    </div>
  </div>

  <div class="card items page mt-12">
    <div class="section-title">Items</div>
    <table id="itemsTable">
      <thead>
        <tr>
          <th class="th-item">Item / Description</th>
          <th class="th-qty">Qty</th>
          <th class="th-price">Price</th>
          <th class="th-tax">Tax %</th>
          <th class="th-total">Line Total</th>
          <th class="th-actions controls-only">Actions</th>
        </tr>
      </thead>
      <tbody id="itemsBody"></tbody>
      <tfoot>
        <tr class="controls-only">
          <td colspan="6" class="td-actions">
            <button class="btn" id="addItemBtn">+ Add Item</button>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="summary page mt-12">
    <div class="card">
      <div class="section-title">Notes & Payment</div>
      <div class="grid">
        <div>
          <label>Payment Instructions</label>
          <textarea id="paymentInfo" placeholder="Zelle / CashApp / Bank detailsâ€¦"></textarea>
        </div>
        <div>
          <label>Notes / Terms</label>
          <textarea id="notes" placeholder="Thank you for your business! Net 30 unless otherwise specified."></textarea>
        </div>
      </div>
      <div class="sig mt-12">
        <div class="row items-center justify-between">
          <div class="section-title m-0">Signature</div>
          <div class="controls-only">
            <button class="btn" id="sigClearBtn">Clear</button>
          </div>
        </div>
        <canvas id="sigPad" width="800" height="180"></canvas>
      </div>
    </div>

    <div class="totals card">
      <div class="line"><span>Subtotal</span><span id="subtotal">$0.00</span></div>
      <div class="line">
        <span>Discount
          <span class="muted">(flat or %)</span></span>
        <span>
          <input id="discount" class="w-140" placeholder="0 or 10%" />
        </span>
      </div>
      <div class="line">
        <span>Tax (global %)</span>
        <span><input id="globalTax" class="w-140" placeholder="0 or 8.25%" /></span>
      </div>
      <div class="line">
        <span>Shipping / Other</span>
        <span><input id="shipping" class="w-140" placeholder="0.00" /></span>
      </div>
      <div class="line total accent"><span>Total</span><span id="grandTotal">$0.00</span></div>
      <div class="line">
        <span>Paid</span>
        <span><input id="paid" class="w-140" placeholder="0.00" /></span>
      </div>
      <div class="line fw-800">
        <span>Balance Due</span><span id="balanceDue">$0.00</span>
      </div>
    </div>
  </div>

  <div class="grid g2 mt-12">
    <div class="card page">
      <div class="section-title">Small Print</div>
      <div class="hint">
        This tool works fully offline. Store templates locally, export/import JSON for backups, and print to PDF for clients.
      </div>
    </div>
    <div class="card page">
      <div class="section-title">About</div>
      <div class="hint">
        Single-file app. No trackers, no external libraries. Customize the accent color and currency. Great for freelancers, shops, and service businesses.
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // --- Elements ---
  const docType = $('#docType');
  const docTypeBadge = $('#docTypeBadge');
  const currencySymbol = $('#currencySymbol');
  const accentPicker = $('#accentPicker');
  const darkModeBtn = $('#darkModeBtn');

  const bizName = $('#bizName'), bizEmail = $('#bizEmail'), bizPhone = $('#bizPhone'),
        bizWebsite = $('#bizWebsite'), bizAddress = $('#bizAddress');
  const clientName = $('#clientName'), clientEmail = $('#clientEmail'), clientPhone = $('#clientPhone'), clientAddress = $('#clientAddress');
  const invNumber = $('#invNumber'), invDate = $('#invDate'), dueDate = $('#dueDate'), poNumber = $('#poNumber');

  const itemsBody = $('#itemsBody'), addItemBtn = $('#addItemBtn');
  const subtotalEl = $('#subtotal'), grandTotalEl = $('#grandTotal'), balanceDueEl = $('#balanceDue');
  const discount = $('#discount'), globalTax = $('#globalTax'), shipping = $('#shipping'), paid = $('#paid');
  const notes = $('#notes'), paymentInfo = $('#paymentInfo');

  const logoInput = $('#logoInput'), logoBox = $('#logoBox'), clearLogoBtn = $('#clearLogoBtn');
  let logoDataUrl = '';

  const newBtn = $('#newBtn'), saveBtn = $('#saveBtn'), loadSelect = $('#loadSelect'), exportBtn = $('#exportBtn'),
        importBtn = $('#importBtn'), importJsonInput = $('#importJsonInput'), printBtn = $('#printBtn');

  const sigPad = $('#sigPad'); const sigCtx = sigPad.getContext('2d', { willReadFrequently: true });
  let drawing = false, last = null;

  // --- Utilities ---
  const fmt = n => (currencySymbol.value || '$') + Number(n || 0).toFixed(2);
  const parseVal = v => {
    if(!v) return 0;
    v = String(v).trim();
    if(v.endsWith('%')) return { type:'percent', value: parseFloat(v.replace('%','')) || 0 };
    return { type:'flat', value: parseFloat(v.replace(/,/g,'')) || 0 };
  };
  const round2 = x => Math.round((x + Number.EPSILON) * 100) / 100;

  // Accent + dark
  const applyAccent = () => document.documentElement.style.setProperty('--accent', accentPicker.value);
  accentPicker.addEventListener('input', applyAccent);
  darkModeBtn.addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    darkModeBtn.textContent = document.documentElement.classList.contains('dark') ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
  });

  // Default dates & number
  const todayISO = () => new Date().toISOString().slice(0,10);
  const plusDaysISO = (d) => { const dt = new Date(); dt.setDate(dt.getDate()+d); return dt.toISOString().slice(0,10); };
  const defaultInvNum = () => 'INV-' + new Date().toISOString().slice(0,10).replaceAll('-','') + '-' + Math.floor(Math.random()*900+100);

  // Items
  function addItemRow(data={}){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><textarea class="it-desc" placeholder="Description">${data.desc||''}</textarea></td>
      <td><input class="it-qty" type="number" min="0" step="0.01" value="${data.qty??1}"></td>
      <td><input class="it-price" type="number" min="0" step="0.01" value="${data.price??0}"></td>
      <td><input class="it-tax" placeholder="0 or 8%" value="${data.tax||''}"></td>
      <td class="it-total" style="text-align:right">${fmt(0)}</td>
      <td class="controls-only row-actions">
        <button class="btn danger it-del">Delete</button>
      </td>
    `;
    itemsBody.appendChild(tr);
    tr.querySelectorAll('input,textarea').forEach(el=>el.addEventListener('input', recalc));
    const delBtn = tr.querySelector('.it-del');
    if(delBtn) delBtn.addEventListener('click', ()=>{ tr.remove(); recalc(); });
    recalc();
  }

  function getItems(){
    return $$('#itemsBody tr').map(tr=>{
      const desc = tr.querySelector('.it-desc').value;
      const qty = parseFloat(tr.querySelector('.it-qty').value)||0;
      const price = parseFloat(tr.querySelector('.it-price').value)||0;
      const taxStr = tr.querySelector('.it-tax').value.trim();
      return { desc, qty, price, tax: taxStr };
    });
  }

  function recalc(){
    let subtotal = 0;
    // per-item totals
    $$('#itemsBody tr').forEach(tr=>{
      const qty = parseFloat(tr.querySelector('.it-qty').value)||0;
      const price = parseFloat(tr.querySelector('.it-price').value)||0;
      const taxParse = parseVal(tr.querySelector('.it-tax').value.trim());
      let line = qty * price;
      if(taxParse.type==='percent' && taxParse.value>0){
        line += (qty*price)*(taxParse.value/100);
      }else if(taxParse.type==='flat' && taxParse.value>0){
        line += taxParse.value;
      }
      line = round2(line);
      subtotal += line;
      tr.querySelector('.it-total').textContent = fmt(line);
    });

    subtotal = round2(subtotal);
    subtotalEl.textContent = fmt(subtotal);

    // discount (flat or %)
    const d = parseVal(discount.value);
    let discountAmt = 0;
    if(d.type==='percent') discountAmt = round2(subtotal*(d.value/100));
    else discountAmt = round2(d.value);

    let taxG = parseVal(globalTax.value);
    const afterDisc = Math.max(0, subtotal - discountAmt);
    let taxAmt = 0;
    if(taxG.type==='percent') taxAmt = round2(afterDisc*(taxG.value/100));
    else taxAmt = round2(taxG.value);

    const ship = round2(parseFloat(shipping.value)||0);
    const total = round2(afterDisc + taxAmt + ship);
    grandTotalEl.textContent = fmt(total);

    const paidAmt = round2(parseFloat(paid.value)||0);
    const balance = round2(Math.max(0, total - paidAmt));
    balanceDueEl.textContent = fmt(balance);
    docTypeBadge.textContent = (docType.value||'Invoice').toUpperCase();
  }

  // Logo
  logoInput.addEventListener('change', e=>{
    const f = e.target.files?.[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      logoDataUrl = reader.result;
      renderLogo();
      saveDraft();
    };
    reader.readAsDataURL(f);
  });
  function renderLogo(){
    logoBox.innerHTML = logoDataUrl ? `<img alt="logo" src="${logoDataUrl}">` : `<span class="muted">Logo</span>`;
  }
  clearLogoBtn.addEventListener('click', ()=>{ logoDataUrl=''; renderLogo(); saveDraft(); });

  // Signature pad
  function sigStart(e){ drawing = true; last = getPos(e); }
  function sigMove(e){
    if(!drawing) return;
    const p = getPos(e);
    sigCtx.lineWidth = 2; sigCtx.lineCap = 'round'; sigCtx.strokeStyle = '#000';
    sigCtx.beginPath();
    sigCtx.moveTo(last.x, last.y);
    sigCtx.lineTo(p.x, p.y);
    sigCtx.stroke();
    last = p;
  }
  function sigEnd(){ drawing = false; last = null; }
  function getPos(e){
    const r = sigPad.getBoundingClientRect();
    const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left;
    const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top;
    // scale to canvas
    return { x: x * (sigPad.width/r.width), y: y * (sigPad.height/r.height) };
  }
  sigPad.addEventListener('mousedown', sigStart);
  sigPad.addEventListener('mousemove', sigMove);
  window.addEventListener('mouseup', sigEnd);
  sigPad.addEventListener('touchstart', sigStart, {passive:true});
  sigPad.addEventListener('touchmove', sigMove, {passive:true});
  sigPad.addEventListener('touchend', sigEnd);
  $('#sigClearBtn').addEventListener('click', ()=>{ sigCtx.clearRect(0,0,sigPad.width,sigPad.height); });

  // Actions
  addItemBtn.addEventListener('click', ()=> addItemRow({qty:1, price:0, tax:''}));
  [discount, globalTax, shipping, paid, currencySymbol].forEach(el=> el.addEventListener('input', recalc));
  [bizName,bizEmail,bizPhone,bizWebsite,bizAddress, clientName,clientEmail,clientPhone,clientAddress,
   invNumber,invDate,dueDate,poNumber,notes,paymentInfo,docType].forEach(el=> el.addEventListener('input', ()=>{ recalc(); saveDraft(); }));
  accentPicker.addEventListener('input', saveDraft);
  currencySymbol.addEventListener('input', saveDraft);

  printBtn.addEventListener('click', ()=> window.print());
  newBtn.addEventListener('click', ()=>{
    if(!confirm('Clear the current document?')) return;
    localLoad(blankDoc());
  });

  saveBtn.addEventListener('click', ()=>{
    const name = prompt('Template name (e.g., "Default", "Acme LLC")?');
    if(!name) return;
    const all = getTemplates();
    all[name] = collectDoc();
    localStorage.setItem('invoice_templates', JSON.stringify(all));
    populateLoadSelect();
    alert('Saved template: ' + name);
  });

  function getTemplates(){
    try { return JSON.parse(localStorage.getItem('invoice_templates')||'{}'); } catch { return {}; }
  }
  function populateLoadSelect(){
    const all = getTemplates();
    const names = Object.keys(all).sort();
    loadSelect.innerHTML = `<option value="">Load Templateâ€¦</option>` + names.map(n=>`<option>${n}</option>`).join('');
  }
  loadSelect.addEventListener('change', ()=>{
    const name = loadSelect.value; if(!name) return;
    const all = getTemplates(); const data = all[name]; if(!data) return;
    localLoad(data);
  });

  exportBtn.addEventListener('click', ()=>{
    const data = JSON.stringify(collectDoc(), null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (docType.value||'Invoice') + '-' + (invNumber.value||'document') + '.json';
    a.click();
  });
  importBtn.addEventListener('click', ()=> importJsonInput.click());
  importJsonInput.addEventListener('change', async e=>{
    const f = e.target.files?.[0]; if(!f) return;
    const text = await f.text();
    try{
      const data = JSON.parse(text);
      localLoad(data);
    }catch(err){
      alert('Invalid JSON.');
    }
  });

  // Persistence (autosave draft)
  function saveDraft(){ localStorage.setItem('invoice_draft', JSON.stringify(collectDoc())); }
  function loadDraft(){
    try{
      const raw = localStorage.getItem('invoice_draft');
      if(!raw){ localLoad(blankDoc()); return; }
      const data = JSON.parse(raw);
      localLoad(data);
    }catch{ localLoad(blankDoc()); }
  }

  // Data model
  function collectDoc(){
    return {
      ui:{
        currency: currencySymbol.value,
        accent: accentPicker.value,
        dark: document.documentElement.classList.contains('dark')
      },
      type: docType.value,
      business:{ name:bizName.value, email:bizEmail.value, phone:bizPhone.value, website:bizWebsite.value, address:bizAddress.value, logo:logoDataUrl },
      client:{ name:clientName.value, email:clientEmail.value, phone:clientPhone.value, address:clientAddress.value },
      meta:{ number:invNumber.value, date:invDate.value, due:dueDate.value, po:poNumber.value },
      items: getItems(),
      totals:{ discount:discount.value, tax:globalTax.value, shipping:shipping.value, paid:paid.value },
      notes: notes.value,
      payment: paymentInfo.value,
      signature: sigPad.toDataURL('image/png')
    };
  }

  function localLoad(data){
    currencySymbol.value = data?.ui?.currency ?? '$';
    accentPicker.value = data?.ui?.accent ?? '#3b82f6';
    document.documentElement.classList.toggle('dark', !!data?.ui?.dark);
    darkModeBtn.textContent = document.documentElement.classList.contains('dark') ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
    applyAccent();

    docType.value = data?.type ?? 'Invoice';
    bizName.value = data?.business?.name ?? '';
    bizEmail.value = data?.business?.email ?? '';
    bizPhone.value = data?.business?.phone ?? '';
    bizWebsite.value = data?.business?.website ?? '';
    bizAddress.value = data?.business?.address ?? '';
    logoDataUrl = data?.business?.logo ?? ''; renderLogo();

    clientName.value = data?.client?.name ?? '';
    clientEmail.value = data?.client?.email ?? '';
    clientPhone.value = data?.client?.phone ?? '';
    clientAddress.value = data?.client?.address ?? '';

    invNumber.value = data?.meta?.number ?? defaultInvNum();
    invDate.value = data?.meta?.date ?? todayISO();
    dueDate.value = data?.meta?.due ?? plusDaysISO(30);
    poNumber.value = data?.meta?.po ?? '';

    itemsBody.innerHTML='';
    (data?.items?.length ? data.items : [{},{},{}]).forEach(it=> addItemRow(it));

    discount.value = data?.totals?.discount ?? '';
    globalTax.value = data?.totals?.tax ?? '';
    shipping.value = data?.totals?.shipping ?? '';
    paid.value = data?.totals?.paid ?? '';

    notes.value = data?.notes ?? '';
    paymentInfo.value = data?.payment ?? '';

    // signature
    try{
      sigCtx.clearRect(0,0,sigPad.width,sigPad.height);
      if(data?.signature){
        const img = new Image();
        img.onload = ()=> sigCtx.drawImage(img,0,0);
        img.src = data.signature;
      }
    }catch{}

    recalc();
    populateLoadSelect();
  }

  function blankDoc(){
    return {
      ui:{ currency:'$', accent:'#3b82f6', dark:false },
      type:'Invoice',
      business:{ name:'', email:'', phone:'', website:'', address:'', logo:'' },
      client:{ name:'', email:'', phone:'', address:'' },
      meta:{ number:defaultInvNum(), date:todayISO(), due:plusDaysISO(30), po:'' },
      items:[{qty:1, price:0, desc:'', tax:''}],
      totals:{ discount:'', tax:'', shipping:'', paid:'' },
      notes:'Thank you for your business!',
      payment:'Please pay by due date.',
      signature:''
    };
  }

  // Initial
  loadDraft();
  // Auto-save on unload
  window.addEventListener('beforeunload', saveDraft);
})();
</script>
</body>
</html>
